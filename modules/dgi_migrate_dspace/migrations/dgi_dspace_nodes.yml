---
id: dspace_nodes
label: Create nodes from DSpace METS file.
migration_group: dspace_to_dgis
source:
  plugin: dgi_migrate.source.migration
  track_changes: true
  migration: dspace_mets_files
  dsf_misc:
    case_insensitive: &case_insensitive true
    base_mods_node: &base_mods_node
      plugin: dgi_migrate.process.xml.context_query
      missing_behavior: skip_process
      source: '@_mods_node'
      xpath: '@_mets_xpath'
    nested_mods_node: &nested_mods_node
      plugin: dgi_migrate.process.xml.context_query
      source: 'parent_value'
      xpath: 'parent_row/dest/_mets_xpath'
    generic_term:
      after: &generic_term_after
        _auth_value_uri:
          - << : *nested_mods_node
            query: 'string(@valueURI)'
            method: evaluate
        _auth_source:
          - << : *nested_mods_node
            query: 'string(@authority)'
            method: evaluate
        _value:
          - << : *nested_mods_node
            query: 'normalize-space(.)'
            method: evaluate
        actual:
          - plugin: get
            source:
              - '@_auth_source'
              - '@_auth_value_uri'
              - '@_value'
              # XXX: Needs to be provided wherever this is used, corresponding
              # to the vocab in which to do the things.
              - '@_vid'
          - plugin: flatten
          - plugin: migration_lookup
            migration: dgis_stub_terms_generic
            stub_id: dgis_stub_terms_generic
      extract: &generic_term_extract
        plugin: dgi_migrate.process.single_extract
        index: [actual]

destination:
  plugin: entity:node
  default_bundle: islandora_object
  validate: &validate true

process:
  _zip_scheme:
    - plugin: default_value
      default_value: zip://

  _mets_fragment:
    - plugin: default_value
      default_value: '#mets.xml'

  _dspace_zip_uri:
    - plugin: dgi_migrate.load_entity
      source: fid
      entity_type: entity:file
    - plugin: dgi_migrate.method
      method: getFileUri
    - plugin: callback
      callable: drupal_realpath

  _mets_xpath:
    - plugin: concat
      source:
        - '@_zip_scheme'
        - '@_dspace_zip_uri'
        - '@_mets_fragment'
    - plugin: dgi_migrate.process.xml.domfile
    - plugin: dgi_migrate.process.xml.xpath
      namespaces:
        mets: 'http://www.loc.gov/METS/'
        mods: 'http://www.loc.gov/mods/v3'
        xsi: 'http://www.w3.org/2001/XMLSchema-instance'
        xlink: 'http://www.w3.org/1999/xlink'
        dim: 'http://www.dspace.org/xmlns/dspace/dim'

  _mets_node:
    - plugin: skip_on_empty
      method: process
      source: '@_mets_xpath'
    - plugin: dgi_migrate.method
      method: query
      args:
        - '//mets:mets[1]'
    - plugin: callback
      callable: iterator_to_array
    - plugin: array_shift

  _mods_node:
    - plugin: skip_on_empty
      method: process
      source: '@_mets_xpath'
    - plugin: dgi_migrate.method
      method: query
      args:
        - '/mets:mets/mets:dmdSec/mets:mdWrap[@MDTYPE="MODS"]/mets:xmlData/mods:mods'
    - plugin: callback
      callable: iterator_to_array
    - plugin: array_shift

  ##### METADATA #####
  title:
    - plugin: dgi_migrate.process.xml.context_query
      source: '@_mets_node'
      xpath: '@_mets_xpath'
      method: evaluate
      query: 'string(//mets:mdWrap[@MDTYPE="MODS"]/mets:xmlData//mods:titleInfo/mods:title)'
    - plugin: default_value
      default_value: Untitled

  # Basing the model off of the mimetype.
  _i8_model_uri:
    - plugin: dgi_migrate.process.xml.context_query
      source: '@_mets_node'
      xpath: '@_mets_xpath'
      method: evaluate
      query: 'string(//mets:fileSec/mets:fileGrp[@USE="ORIGINAL"]/mets:file/@MIMETYPE)'
    # - plugin: default_value
    #   default_value: '@_is_collection'
    - plugin: static_map
      bypass: false
      map:
        'application/jpeg': 'http://purl.org/coar/resource_type/c_c513'
        'application/pdf': 'https://schema.org/DigitalDocument'
        '': 'http://purl.org/dc/dcmitype/Collection'
  field_model:
    - plugin: entity_lookup
      source: '@_i8_model_uri'
      bundle_key: vid
      bundle: islandora_models
      value_key: field_external_uri
      entity_type: taxonomy_term
      ignore_case: true
    - plugin: skip_on_empty
      method: row
      message: 'Failed to lookup the model taxonomy term.'

  _resource_type:
    - << : *base_mods_node
      query: 'mods:typeOfResource'
    - plugin: callback
      callable: iterator_to_array
    - plugin: multiple_values
    - plugin: dgi_migrate.subproperty
      property: nodeValue
    - plugin: single_value
    - plugin: callback
      callable: array_filter
  field_resource_type:
    - plugin: default_value
      source: '@_resource_type'
      default_value: Unspecified
    - plugin: entity_generate
      bundle: resource_types
      bundle_key: vid
      entity_type: taxonomy_term
      value_key: name
      ignore_case: *case_insensitive

  field_display_hints:
    - plugin: skip_on_value
      source: '@_i8_model_uri'
      method: process
      value: 'http://purl.org/dc/dcmitype/Collection'
    - plugin: dgi_migrate.process.static_map
      source: '@_i8_model_uri'
      bypass: true
      map:
        - ['https://schema.org/DigitalDocument', ['http://mozilla.github.io/pdf.js']]
        - ['http://purl.org/coar/resource_type/c_c513', ['http://openseadragon.github.io']]
        - ['http://id.loc.gov/ontologies/bibframe/part', ['http://openseadragon.github.io']]
    - plugin: flatten
    - plugin: skip_on_empty
      method: process
    - plugin: entity_lookup
      bundle_key: vid
      bundle: islandora_display
      value_key: field_external_uri
      entity_type: taxonomy_term
      # XXX: migrate_plus's case comparison makes assumptions about the entity's
      # "main" property... we want "uri", but it assumes "value".
      ignore_case: true

  field_handle:
    - << : *base_mods_node
      query: 'mods:identifier[@type="uri"]'
    - plugin: callback
      callable: iterator_to_array
    - plugin: multiple_values
    - plugin: dgi_migrate.subproperty
      property: nodeValue
    - plugin: single_value
    - plugin: null_coalesce

  field_description:
    - << : *base_mods_node
      query: 'mods:abstract'
    - plugin: callback
      callable: iterator_to_array
    - plugin: multiple_values
    - plugin: dgi_migrate.subproperty
      property: nodeValue
    - plugin: single_value
    - plugin: null_coalesce

  field_extent:
    - << : *base_mods_node
      query: 'mods:physicalDescription/mods:extent'
    - plugin: callback
      callable: iterator_to_array
    - plugin: multiple_values
    - plugin: dgi_migrate.subproperty
      property: nodeValue
    - plugin: single_value
    - plugin: null_coalesce

  field_use_and_reproduction:
    - << : *base_mods_node
      query: 'mods:accessCondition[@type="useAndReproduction"]'
    - plugin: callback
      callable: iterator_to_array
    - plugin: multiple_values
    - plugin: dgi_migrate.subproperty
      property: nodeValue
    - plugin: single_value
    - plugin: null_coalesce

  _genre:
    - << : *base_mods_node
      query: 'mods:genre'
    - plugin: callback
      callable: iterator_to_array
    - plugin: multiple_values
    - plugin: dgi_migrate.subproperty
      property: nodeValue
    - plugin: single_value
    - plugin: null_coalesce
  field_genre:
    - plugin: default_value
      source: '@_genre'
      default_value: Unspecified
    - plugin: entity_generate
      bundle: genre
      bundle_key: vid
      entity_type: taxonomy_term
      value_key: name
      ignore_case: *case_insensitive

  field_local_identifier:
    - << : *base_mods_node
      query: 'mods:identifier[@type="local"]'
    - plugin: callback
      callable: iterator_to_array
    - plugin: multiple_values
    - plugin: dgi_migrate.subproperty
      property: nodeValue
    - plugin: single_value
    - plugin: null_coalesce

  _language:
    - << : *base_mods_node
      query: 'mods:language/mods:languageTerm'
    - plugin: callback
      callable: iterator_to_array
    - plugin: multiple_values
    - plugin: dgi_migrate.subproperty
      property: nodeValue
    - plugin: single_value
    - plugin: null_coalesce
  field_language:
    - plugin: default_value
      source: '@_language'
      default_value: Unspecified
    - plugin: entity_generate
      bundle: language
      bundle_key: vid
      entity_type: taxonomy_term
      value_key: name
      ignore_case: *case_insensitive

  field_note:
    - << : *base_mods_node
      query: 'mods:note[not(@type)]'
    - plugin: callback
      callable: iterator_to_array
    - plugin: multiple_values
    - plugin: dgi_migrate.subproperty
      property: nodeValue
    - plugin: single_value
    - plugin: null_coalesce

  field_title:
    - << : *base_mods_node
      query: 'mods:titleInfo/mods:title'
    - plugin: callback
      callable: iterator_to_array
    - plugin: multiple_values
    - plugin: dgi_paragraph_generate
      validate: *validate
      type: title
      process_values: true
      values:
        field_title_type:
          - << : *nested_mods_node
            query: '@type'
          - plugin: callback
            callable: iterator_to_array
          - plugin: multiple_values
          - plugin: dgi_migrate.subproperty
            property: nodeValue
          - plugin: single_value
          - plugin: null_coalesce
        field_title:
          - plugin: dgi_migrate.subproperty
            source: 'parent_value'
            property: nodeValue

  field_note_paragraph:
    - << : *base_mods_node
      query: 'mods:note[@type]'
    - plugin: callback
      callable: iterator_to_array
    - plugin: multiple_values
    - plugin: dgi_paragraph_generate
      validate: *validate
      type: title
      process_values: true
      values:
        field_note_type:
          - << : *nested_mods_node
            query: '@type'
          - plugin: callback
            callable: iterator_to_array
          - plugin: multiple_values
          - plugin: dgi_migrate.subproperty
            property: nodeValue
          - plugin: single_value
          - plugin: null_coalesce
        field_note:
          - plugin: dgi_migrate.subproperty
            source: 'parent_value'
            property: nodeValue

  field_origin_information:
    - << : *base_mods_node
      query: 'mods:originInfo'
    - plugin: callback
      callable: iterator_to_array
    - plugin: multiple_values
    - plugin: dgi_paragraph_generate
      validate: *validate
      type: origin_information
      process_values: true
      values:
        _field_date_captured_single:
          - << : *nested_mods_node
            query: '..//mods:extension/mods:dateAccessioned'
          - plugin: callback
            callable: iterator_to_array
          - plugin: multiple_values
          - plugin: dgi_migrate.subproperty
            property: nodeValue
          - plugin: single_value
          - plugin: null_coalesce
        _field_date_captured_start:
          - << : *nested_mods_node
            query: 'mods:dateCaptured[@point="start"]'
          - plugin: callback
            callable: iterator_to_array
          - plugin: multiple_values
          - plugin: dgi_migrate.subproperty
            property: nodeValue
          - plugin: single_value
          - plugin: null_coalesce
        _field_date_captured_end:
          - << : *nested_mods_node
            query: 'mods:dateCaptured[@point="end"]'
          - plugin: callback
            callable: iterator_to_array
          - plugin: multiple_values
          - plugin: dgi_migrate.subproperty
            property: nodeValue
          - plugin: single_value
          - plugin: null_coalesce
        field_date_captured:
          - plugin: dgi_migrate.process.assemble_date
            single_date: '@_field_date_captured_single'
            range_start: '@_field_date_captured_start'
            range_end: '@_field_date_captured_end'
            get_values: true
          - plugin: dgi_migrate_edtf_validator
            intervals: false
            strict: true
        _field_date_issued_single:
          - << : *nested_mods_node
            query: 'mods:dateIssued[not(@start)]'
          - plugin: callback
            callable: iterator_to_array
          - plugin: multiple_values
          - plugin: dgi_migrate.subproperty
            property: nodeValue
          - plugin: single_value
          - plugin: null_coalesce
        _field_date_issued_start:
          - << : *nested_mods_node
            query: '../mods:extension/mods:dateIssued[@point="start"]'
          - plugin: callback
            callable: iterator_to_array
          - plugin: multiple_values
          - plugin: dgi_migrate.subproperty
            property: nodeValue
          - plugin: single_value
          - plugin: null_coalesce
        _field_date_issued_end:
          - << : *nested_mods_node
            query: '../mods:extension/mods:dateIssued[@point="end"]'
          - plugin: callback
            callable: iterator_to_array
          - plugin: multiple_values
          - plugin: dgi_migrate.subproperty
            property: nodeValue
          - plugin: single_value
          - plugin: null_coalesce
        field_date_issued:
          - plugin: dgi_migrate.process.assemble_date
            single_date: '@_field_date_issued_single'
            range_start: '@_field_date_issued_start'
            range_end: '@_field_date_issued_end'
            get_values: true
          - plugin: skip_on_empty
            method: process
          - plugin: dgi_migrate_edtf_validator
            intervals: true
            strict: true
        _field_other_date_single:
          - << : *nested_mods_node
            query: 'mods:dateOther[not(@point)]'
          - plugin: callback
            callable: iterator_to_array
          - plugin: multiple_values
          - plugin: dgi_migrate.subproperty
            property: nodeValue
          - plugin: single_value
          - plugin: null_coalesce
        _field_other_date_start:
          - << : *nested_mods_node
            query: 'mods:dateOther[@point="start"]'
          - plugin: callback
            callable: iterator_to_array
          - plugin: multiple_values
          - plugin: dgi_migrate.subproperty
            property: nodeValue
          - plugin: single_value
          - plugin: null_coalesce
        _field_other_date_end:
          - << : *nested_mods_node
            query: 'mods:dateOther[@point="end"]'
          - plugin: callback
            callable: iterator_to_array
          - plugin: multiple_values
          - plugin: dgi_migrate.subproperty
            property: nodeValue
          - plugin: single_value
          - plugin: null_coalesce
        field_other_date:
          - plugin: dgi_migrate.process.assemble_date
            single_date: '@_field_other_date_single'
            range_start: '@_field_other_date_start'
            range_end: '@_field_other_date_end'
            get_values: true
          - plugin: dgi_migrate_edtf_validator
            intervals: true
            strict: true
        field_publisher:
          - << : *nested_mods_node
            query: 'mods:publisher'
          - plugin: callback
            callable: iterator_to_array
          - plugin: multiple_values
          - plugin: dgi_migrate.subproperty
            property: nodeValue

  field_related_item_paragraph:
    - << : *base_mods_node
      query: 'mods:relatedItem'
    - plugin: callback
      callable: iterator_to_array
    - plugin: multiple_values
    - plugin: dgi_paragraph_generate
      validate: *validate
      type: related_item
      process_values: true
      values:
        field_relationship_type:
          - << : *nested_mods_node
            query: '@type'
          - plugin: callback
            callable: iterator_to_array
          - plugin: multiple_values
          - plugin: dgi_migrate.subproperty
            property: nodeValue
          - plugin: single_value
          - plugin: callback
            callable: array_filter
          - plugin: skip_on_empty
            method: process
          - plugin: multiple_values
          - plugin: entity_lookup
            bundle: mods_relation_types
            bundle_key: vid
            entity_type: taxonomy_term
            value_key: name
          - plugin: skip_on_empty
            method: row
            message: "Encountered invalid relatedItem/@type attribute"
        _title_plain_part:
          - << : *nested_mods_node
            query: 'mods:part/mods:text'
          - plugin: callback
            callable: iterator_to_array
          - plugin: multiple_values
          - plugin: dgi_migrate.subproperty
            property: nodeValue
        field_title_plain:
          - << : *nested_mods_node
            query: '.'
          - plugin: callback
            callable: iterator_to_array
          - plugin: multiple_values
          - plugin: dgi_migrate.subproperty
            property: nodeValue
          - plugin: callback
            callable: trim
          - plugin: single_value
          - plugin: callback
            callable: array_filter
          - plugin: get
            source: '@_title_plain_part'
          - plugin: null_coalesce
        field_url/uri:
          - << : *nested_mods_node
            query: 'mods:location/mods:url[normalize-space()]'
          - plugin: callback
            callable: iterator_to_array
          - plugin: multiple_values
          - plugin: dgi_migrate.subproperty
            property: nodeValue
          - plugin: callback
            callable: trim
          - plugin: single_value
          - plugin: callback
            callable: array_filter
          - plugin: null_coalesce
        field_related_item_extent:
          - << : *nested_mods_node
            query: 'mods:physicalDescription/mods:extent[normalize-space()]'
          - plugin: callback
            callable: iterator_to_array
          - plugin: multiple_values
          - plugin: dgi_migrate.subproperty
            property: nodeValue
          - plugin: callback
            callable: trim
          - plugin: single_value
          - plugin: callback
            callable: array_filter
          - plugin: null_coalesce

  field_temporal:
    - << : *base_mods_node
      query: 'mods:subject/mods:temporal[normalize-space()]'
    - plugin: callback
      callable: iterator_to_array
    - plugin: skip_on_empty
      method: process
    - plugin: multiple_values
    - plugin: dgi_migrate.subproperty
      property: nodeValue
    - plugin: callback
      callable: trim
    - plugin: entity_generate
      bundle: temporal
      bundle_key: vid
      entity_type: taxonomy_term
      value_key: name
      ignore_case: *case_insensitive

  _subject_topic:
    - << : *base_mods_node
      query: 'mods:subject/mods:topic[normalize-space()]'
    - plugin: callback
      callable: iterator_to_array
    - plugin: skip_on_empty
      method: process
    - plugin: multiple_values
    - plugin: dgi_migrate.subproperty
      property: nodeValue
    - plugin: callback
      callable: trim
    - plugin: entity_generate
      bundle: subject
      bundle_key: vid
      entity_type: taxonomy_term
      value_key: name
      ignore_case: *case_insensitive

  field_subject:
    - plugin: get
      source:
        - '@_subject_topic'
        # - '@_subject_name_personal'
        # - '@_subject_name_corporate'
    - plugin: flatten

  field_linked_agent:
    - << : *base_mods_node
      query: 'mods:name[not(@type)]'
    - plugin: dgi_migrate.typed_relation
      field_name: node.islandora_object.field_linked_agent
      xpath: '@_mets_xpath'
      default_role: 'relators:asn'
      process_values: true
      values:
        _authority:
          - << : *nested_mods_node
            query: 'normalize-space(@authority)'
            method: evaluate
        _value_uri:
          - << : *nested_mods_node
            query: 'normalize-space(@valueURI)'
            method: evaluate
        _given_name:
          - << : *nested_mods_node
            query: 'normalize-space(mods:namePart[@type="given"][normalize-space()][1])'
            method: evaluate
        _family_name:
          - << : *nested_mods_node
            query: 'normalize-space(mods:namePart[@type="family"][normalize-space()][1])'
            method: evaluate
        _date_name:
          - << : *nested_mods_node
            query: 'normalize-space(mods:namePart[@type="date"][normalize-space()][1])'
            method: evaluate
        _display_form:
          - << : *nested_mods_node
            query: 'normalize-space(mods:displayForm[normalize-space()][1])'
            method: evaluate
        _untyped_names:
          - << : *nested_mods_node
            query: 'normalize-space(mods:namePart[not(@type)][normalize-space()])'
            method: evaluate
        target_id:
          - plugin: get
            source:
              - '@_authority'
              - '@_value_uri'
              - '@_untyped_names'
              - '@_given_name'
              - '@_family_name'
              - '@_date_name'
              - '@_display_form'
          - plugin: flatten
          - plugin: migration_lookup
            migration: dspace_stub_terms_person
            stub_id: dspace_stub_terms_person
          - plugin: skip_on_empty
            method: row

migration_dependencies:
  required:
    - dgis_mets_files
    - islandora_tags
    - dspace_stub_terms_corporate_body
    - dspace_stub_terms_corporate_body
    - dspace_stub_terms_generic

dependencies:
  enforced:
    module:
      - dgi_migrate
      - dgi_migrate_dspace
      - dgi_migrate_paragraphs
