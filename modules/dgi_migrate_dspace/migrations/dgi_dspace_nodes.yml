---
id: dspace_nodes
label: Create nodes from DSpace METS file.
migration_group: dspace_to_dgis
source:
  plugin: dgi_migrate.source.migration
  track_changes: true
  migration: dspace_mets_files

destination:
  plugin: entity:node
  default_bundle: islandora_object
  validate: &validate true

process:
  _zip_scheme:
    - plugin: default_value
      default_value: zip://

  _mets_fragment:
    - plugin: default_value
      default_value: '#mets.xml'

  _dspace_zip_uri:
    - plugin: dgi_migrate.load_entity
      source: fid
      entity_type: entity:file
    - plugin: dgi_migrate.method
      method: getFileUri
    - plugin: callback
      callable: drupal_realpath

  _mets_content:
    - plugin: concat
      source:
        - '@_zip_scheme'
        - '@_dspace_zip_uri'
        - '@_mets_fragment'
    - plugin: callback
      callable: file_get_contents
    - plugin: dgi_migrate.process.xml.domstring
    - plugin: dgi_migrate.process.xml.xpath
      namespaces:
        mets: 'http://www.loc.gov/METS/'
        mods: 'http://www.loc.gov/mods/v3'
        xsi: 'http://www.w3.org/2001/XMLSchema-instance'
        xlink: 'http://www.w3.org/1999/xlink'
        dim: 'http://www.dspace.org/xmlns/dspace/dim'

  _mets_node:
    - plugin: skip_on_empty
      method: process
      source: '@_mets_content'
    - plugin: dgi_migrate.method
      method: query
      args:
        - '//mets:mets[1]'
    - plugin: callback
      callable: iterator_to_array
    - plugin: array_shift

  title:
    - plugin: dgi_migrate.process.xml.context_query
      source: '@_mets_node'
      xpath: '@_mets_content'
      method: evaluate
      query: 'string(//mets:mdWrap[@MDTYPE="MODS"]/mets:xmlData//mods:titleInfo/mods:title)'
    - plugin: default_value
      default_value: Untitled
  # Basing the model off of the mimetype.
  _i8_model_uri:
    - plugin: dgi_migrate.process.xml.context_query
      source: '@_mets_node'
      xpath: '@_mets_content'
      method: evaluate
      query: 'string(//mets:fileSec/mets:fileGrp[@USE="ORIGINAL"]/mets:file/@MIMETYPE)'
    - plugin: static_map
      bypass: false
      map:
        'application/jpeg': 'http://purl.org/coar/resource_type/c_c513'
        'application/pdf': 'https://schema.org/DigitalDocument'
  field_model:
    - plugin: entity_lookup
      source: '@_i8_model_uri'
      bundle_key: vid
      bundle: islandora_models
      value_key: field_external_uri
      entity_type: taxonomy_term
      ignore_case: true
    - plugin: skip_on_empty
      method: row
      message: 'Failed to lookup the model taxonomy term.'
  field_resource_type:
    - plugin: default_value
      source: '@_resource_type'
      default_value: Unspecified
    - plugin: entity_generate
      bundle: resource_types
      bundle_key: vid
      entity_type: taxonomy_term
      value_key: name
      ignore_case: &case_insensitive true
  # field_display_hints:
  #   - plugin: dgi_migrate.process.static_map
  #     source: '@_i8_model_uri'
  #     bypass: true
  #     map:
  #       - ['https://schema.org/DigitalDocument', ['http://mozilla.github.io/pdf.js']]
  #       - ['http://purl.org/coar/resource_type/c_c513', ['http://openseadragon.github.io']]
  #       - ['http://id.loc.gov/ontologies/bibframe/part', ['http://openseadragon.github.io']]
  #   - plugin: flatten
  #   - plugin: skip_on_empty
  #     method: process
  #   - plugin: entity_lookup
  #     bundle_key: vid
  #     bundle: islandora_display
  #     value_key: field_external_uri
  #     entity_type: taxonomy_term
  #     # XXX: migrate_plus's case comparison makes assumptions about the entity's
  #     # "main" property... we want "uri", but it assumes "value".
  #     ignore_case: true
  # field_handle:
  #   - plugin: dgi_migrate.method
  #     source: '@_node_mets_parsed'
  #     method: query
  #     arg: ['//mets:dmdSec//dim:field[@mdschema="dc" and @element="identifier" and @qualifier="uri"]']

dependencies:
  enforced:
    module:
      - dgi_migrate_dspace
